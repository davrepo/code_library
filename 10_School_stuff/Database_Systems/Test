DROP FUNCTION IF EXISTS PayOneBill( IN iBID INTEGER );

CREATE FUNCTION PayOneBill( IN iBID INTEGER )
RETURNS VOID 
AS 
$$
DECLARE
	availableFund INTEGER;
	maxAccountID INTEGER;
    ammountToPay INTEGER;
BEGIN
	maxAccountID, availableFund := (
        SELECT accounts.aid, abalance + aover AS total_funds 
        FROM bills 
        JOIN accounts ON bills.pid = accounts.pid
        GROUP BY accounts.aid, bills.pid, accounts.abalance, accounts.aover
        HAVING abalance + aover = MAX(abalance + aover)
    );

    ammountToPay := (
        SELECT bamount 
        FROM bills 
        WHERE bills.bid = iBID
    );

    -- this check is not necessary, b/c trigger #3 will prevent this and maintain consistency
    IF availableFund < ammountToPay THEN
        RAISE EXCEPTION 'Not enough funds' USING ERRCODE = '45000';
    ELSE 
        UPDATE accounts SET abalance = abalance - ammountToPay WHERE aid = maxAccountID;
        UPDATE bills SET bpaid = TRUE WHERE bid = iBID;
    END IF;
	
	RETURN;
END;
$$ 
LANGUAGE plpgsql;